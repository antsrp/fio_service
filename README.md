# fio_service

# Команды  

Общий запуск (запускает все компоненты)  
`
make run-all
`

Запуск go-приложения  
`
make run
`

Запуск docker-образов  
`
make docker-start
`

Запуск миграции  
`
make migrateup
`

Отмена миграции  
`
make migratedown
`

Запуск тестов  
`
make test
`

# Общий принцип приложения

Приложение принимает запросы как с помощью REST методов, так и с помощью GraphQL методов.  

При запросе на добавление переданные данные считываются и с помощью одного из producer-ов отправляются в очередь в топик FIO. Оттуда данные считывает асинхронно запущенный consumer, который определяет, все ли необходимые поля заданы при запросе.  
В случае, если данных недостаточно, запрос, обогащенный причиной отказа, с помощью другого producer'а отправляется в топик FIO_FAILED. В ином случае данные обогаются наиболее вероятными возрастом (api.agify.io), полом (api.genderize.io), а также национальностью (api.nationalize.io). После этого полученные запросами данные отправляются в хранилище redis, чтобы в следующий раз получить данные быстрее, не используя дополнительные http запросы.  
Обогащенные данные идут на сохранение в БД postgres.

При удалении в запрос необходимо передать id удаляемой записи, после проведения операции в БД система сообщает, была ли удалена запись (например, если передан несуществующий id, ни одна запись не удалится).  

При изменения в запрос необходимо передать id удаляемой записи, а также хотя новое значение для хотя бы одного из полей, в ином случае будет возвращена ошибка. По аналогии с удалением, система скажет, была ли затронута какая-либо сущность или нет.  

Для получения записей передавать данные необязательно, при этом, есть опционные параметры (см. ниже).  

# REST API

Каждый запрос этого типа имеет общий адрес:  
host:port/api/v1/fio  

| Описание запроса | Метод | Параметры |
|------------------|-------|-----------|
|Добавление        |POST   |body(name string, surname string, patronym string)       |
|Удаление        |DELETE   |query(id int [обяз]) |
|Изменение        |PATCH   |body (id int [обяз], name string, surname string, patronym string, age int, gender string, nationality string) |
|Получение        |GET   |query(page int, where string, order string) |

# GraphQL

host:port/graphql - playground для формирования запросов  

| Описание запроса | Пример запроса |
|------------------|----------------|
|Добавление        | mutation{addPerson(name: "", surname:"", patronym:"")}      |
|Удаление          |mutation{deletePerson(id: val)} |
|Изменение        |mutation{updatePerson(id: val, params...)}   |
|Получение        |query{getPersons(page: val, where: "", order: ""){params to show in result...}} |

# Объяснение параметров запроса на получение данных
- page - номер страницы (без задания этого параметра будут выводиться все сущности)
- where - where clause sql. Знаки &, |, ! заменяются на AND, OR, AND соответственно. Условие != можно задать с помощью <>. Таким образом:   
where="age>2|name<>'alex'" -> WHERE AGE > 2 OR NAME != 'ALEX'  
where="id<=50&name='andrey'&age!IN" -> WHERE id <= 50 AND NAME = 'Andrey' AND AGE NOT IN (20,30)
- order - сортировка по столбцам, пример: order=id,name DESC

# Задаваемые в .env параметры
Параметры БД:
- DB_TYPE - тип БД (postgres)
- DB_HOST - хост 
- DB_PORT - порт
- DB_USER - имя пользователя
- DB_PASS - пароль
- DB_NAME - название
- DB_COUNT_ON_PAGE - максимальное количество записей на одной странице при пагинации

Параметры кэш-хранилища:
- STORE_TYPE - тип (redis)
- STORE_HOST - хост
- STORE_PORT - порт
- STORE_PASS - пароль
- STORE_DB - номер базы
- STORE_EXPIRATION_TIME - время хранения (в минутах)

Параметры брокера:
- BROKER_TYPE - тип (kafka)
- BROKER_HOST - хост
- BROKER_PORT - порт
- BROKER_GROUP_ID - название группы consumer'ов
- BROKER_TOPIC - название топика, куда класть и откуда считывать сущности на добавление 
- BROKER_TOPIC_FAILED - название топика, куда класть отклоненные сущности

Параметры http-сервера:
- SERVER_HOST - хост
- SERVER_PORT - порт

# Используемые технологии и компоненты

сервер http - golang  
БД - postgres  
Кэш-хранилище - redis  
Брокер сообщений - Apache Kafka